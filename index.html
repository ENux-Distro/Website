<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Daily Planner</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel (to interpret JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-width { transition: width 0.5s ease-in-out; }
        
        /* Custom styling to ensure time inputs show AM/PM properly on all browsers */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
            cursor: pointer;
        }
        
        /* Modern Focus Glow */
        .timer-active {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- 5. Firebase Loader Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseLib = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };

        window.dispatchEvent(new Event('firebase-modules-loaded'));
    </script>

    <!-- 6. The React Application -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Scaled down to 18px for better visual balance) ---
        const Icons = {
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            BatteryLow: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="16" height="10" rx="2" ry="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="11" x2="6" y2="13"/></svg>,
            BatteryMedium: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="16" height="10" rx="2" ry="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="11" x2="10" y2="11"/><line x1="6" y1="13" x2="10" y2="13"/></svg>,
            BatteryFull: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="16" height="10" rx="2" ry="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="11" x2="14" y2="11"/><line x1="6" y1="13" x2="14" y2="13"/></svg>,
            Dumbbell: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Coffee: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        
        // Helper to format 24h string to 12h display
        const format12h = (time24) => {
            if (!time24) return '';
            const [hrs, mins] = time24.split(':');
            const h = parseInt(hrs);
            const suffix = h >= 12 ? 'PM' : 'AM';
            const h12 = ((h + 11) % 12 + 1);
            return `${h12}:${mins} ${suffix}`;
        };

        const defaultTasks = [
          { id: '1', time: '08:00', title: 'Wake up & Hydrate', completed: false, type: 'routine', duration: 30 },
          { id: '2', time: '09:00', title: 'Deep Work Session', completed: false, type: 'work', duration: 90 },
          { id: '3', time: '12:30', title: 'Healthy Lunch', completed: false, type: 'break', duration: 60 },
          { id: '4', time: '18:00', title: 'Wind Down', completed: false, type: 'routine', duration: 60 },
        ];

        const workoutTasks = [
          { id: 'w1', time: '07:30', title: 'Morning Jog / HIIT', completed: false, type: 'health', duration: 30 },
          { id: 'w2', time: '17:30', title: 'Gym Session', completed: false, type: 'health', duration: 60 },
        ];

        const lightMovementTasks = [
          { id: 'l1', time: '07:45', title: 'Light Stretching', completed: false, type: 'health', duration: 15 },
          { id: 'l2', time: '15:00', title: '10-min Walk', completed: false, type: 'health', duration: 10 },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [plan, setPlan] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTimer, setActiveTimer] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appIdRef = useRef('default-app-id');

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebaseLib) return;
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        appIdRef.current = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const app = window.firebaseLib.initializeApp(firebaseConfig);
                        authRef.current = window.firebaseLib.getAuth(app);
                        dbRef.current = window.firebaseLib.getFirestore(app);

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.firebaseLib.signInWithCustomToken(authRef.current, __initial_auth_token);
                        } else {
                            await window.firebaseLib.signInAnonymously(authRef.current);
                        }

                        window.firebaseLib.onAuthStateChanged(authRef.current, (u) => setUser(u));
                    } catch (e) { console.error(e); setLoading(false); }
                };
                if (window.firebaseLib) initFirebase();
                else window.addEventListener('firebase-modules-loaded', initFirebase);
            }, []);

            useEffect(() => {
                if (!user || !dbRef.current) return;
                const today = getTodayDateString();
                const { doc, onSnapshot, setDoc } = window.firebaseLib;
                const planRef = doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'daily_plans', today);

                const unsubscribe = onSnapshot(planRef, (docSnap) => {
                    if (docSnap.exists()) setPlan(docSnap.data());
                    else {
                        const initialPlan = { date: today, tasks: defaultTasks, energyLevel: 'medium', workoutMode: false };
                        setDoc(planRef, initialPlan);
                        setPlan(initialPlan);
                    }
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (isTimerRunning && timeLeft > 0) {
                    timerRef.current = setTimeout(() => setTimeLeft(p => p - 1), 1000);
                } else if (timeLeft === 0 && isTimerRunning) {
                    setIsTimerRunning(false);
                }
                return () => clearTimeout(timerRef.current);
            }, [timeLeft, isTimerRunning]);

            const updatePlan = async (newPlan) => {
                setPlan(newPlan);
                if (!user || !dbRef.current) return;
                const { doc, setDoc } = window.firebaseLib;
                await setDoc(doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'daily_plans', newPlan.date), newPlan);
            };

            const toggleTask = (id) => {
                const tasks = plan.tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
                updatePlan({ ...plan, tasks });
            };

            const deleteTask = (id) => {
                updatePlan({ ...plan, tasks: plan.tasks.filter(t => t.id !== id) });
            };

            const addTask = () => {
                const newTask = { id: generateId(), time: '12:00', title: 'New Task', completed: false, type: 'work', duration: 30 };
                updatePlan({ ...plan, tasks: [...plan.tasks, newTask].sort((a,b) => a.time.localeCompare(b.time)) });
            };

            const startTimer = (task) => {
                if (activeTimer === task.id && isTimerRunning) setIsTimerRunning(false);
                else {
                    setActiveTimer(task.id);
                    setTimeLeft((task.duration || 25) * 60);
                    setIsTimerRunning(true);
                }
            };

            const getCompletion = () => {
                if (!plan || !plan.tasks.length) return 0;
                return Math.round((plan.tasks.filter(t => t.completed).length / plan.tasks.length) * 100);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>;

            return (
                <div className="min-h-screen pb-12 bg-slate-50">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-3 shadow-sm">
                        <div className="max-w-xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <span className="text-indigo-600"><Icons.Zap /></span> Focus & Flow
                                </h1>
                                <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Daily Protocol</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="text-[10px] font-bold text-slate-400 uppercase">Progress</div>
                                    <div className="text-indigo-600 font-black text-sm">{getCompletion()}%</div>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center border-2 border-indigo-100">
                                    <span className="font-bold text-xs text-indigo-600">{plan?.tasks.filter(t => t.completed).length}</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto px-4 py-6 space-y-6">
                        
                        {/* Energy & Activity */}
                        <section className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase mb-2">Energy</label>
                                <div className="flex gap-1 bg-slate-50 p-1 rounded-lg">
                                    {['low', 'medium', 'high'].map(l => (
                                        <button key={l} onClick={() => updatePlan({...plan, energyLevel: l})} className={`flex-1 py-1 rounded-md flex justify-center ${plan?.energyLevel === l ? 'bg-white shadow-sm ring-1 ring-slate-200 text-indigo-600' : 'text-slate-400'}`}>
                                            {l === 'low' ? <Icons.BatteryLow /> : l === 'medium' ? <Icons.BatteryMedium /> : <Icons.BatteryFull />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={() => {
                                const newMode = !plan.workoutMode;
                                let tasks = plan.tasks.filter(t => !['w1', 'w2', 'l1', 'l2'].includes(t.id));
                                if (newMode) tasks.push(...workoutTasks); else tasks.push(...lightMovementTasks);
                                updatePlan({...plan, workoutMode: newMode, tasks: tasks.sort((a,b) => a.time.localeCompare(b.time))});
                            }} className={`p-3 rounded-xl border transition-all flex flex-col justify-between text-left ${plan?.workoutMode ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-400 shadow-sm'}`}>
                                <label className="block text-[10px] font-bold uppercase opacity-60">Fitness Mode</label>
                                <div className="flex items-center justify-between mt-1">
                                    <span className="font-bold text-sm">{plan?.workoutMode ? 'Active' : 'Rest'}</span>
                                    <Icons.Dumbbell />
                                </div>
                            </button>
                        </section>

                        {/* Timeline */}
                        <section className="space-y-3">
                            <div className="flex justify-between items-center px-1">
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Timeline</h2>
                                <button onClick={addTask} className="text-xs text-indigo-600 font-bold hover:underline">+ Add Task</button>
                            </div>
                            <div className="space-y-2">
                                {plan?.tasks.map((task, idx) => (
                                    <div key={task.id} className={`group flex items-center gap-3 p-3 rounded-xl border transition-all ${task.completed ? 'bg-slate-50/50 border-slate-100 opacity-50' : (activeTimer === task.id && isTimerRunning ? 'bg-white timer-active ring-2 ring-indigo-500/10' : 'bg-white border-slate-200 shadow-sm')}`}>
                                        
                                        {/* Time Logic with AM/PM view */}
                                        <div className="flex flex-col items-center min-w-[65px]">
                                            <input type="time" value={task.time} onChange={(e) => {
                                                const ts = [...plan.tasks]; ts[idx].time = e.target.value;
                                                updatePlan({...plan, tasks: ts.sort((a,b) => a.time.localeCompare(b.time))});
                                            }} className="bg-transparent text-[10px] font-black text-indigo-600 focus:outline-none w-full text-center" />
                                            <div className="text-[9px] font-bold text-slate-400 leading-none mt-0.5">{format12h(task.time)}</div>
                                        </div>

                                        <button onClick={() => toggleTask(task.id)} className={`transition-colors ${task.completed ? 'text-emerald-500' : 'text-slate-200 hover:text-indigo-400'}`}>
                                            <Icons.CheckCircle />
                                        </button>

                                        <div className="flex-grow">
                                            <input type="text" value={task.title} onChange={(e) => {
                                                const ts = [...plan.tasks]; ts[idx].title = e.target.value;
                                                updatePlan({...plan, tasks: ts});
                                            }} className={`bg-transparent w-full text-sm font-semibold focus:outline-none ${task.completed ? 'line-through text-slate-400' : 'text-slate-700'}`} />
                                            
                                            {!task.completed && (
                                                <div className="flex items-center gap-3 mt-1">
                                                    <button onClick={() => startTimer(task)} className={`flex items-center gap-1.5 text-[9px] font-black uppercase px-2 py-0.5 rounded-full ${activeTimer === task.id && isTimerRunning ? 'bg-red-500 text-white' : 'bg-indigo-50 text-indigo-600'}`}>
                                                        {activeTimer === task.id && isTimerRunning ? <Icons.Square /> : <Icons.Play />}
                                                        {activeTimer === task.id ? `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}` : `${task.duration || 30}m Focus`}
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <button onClick={() => deleteTask(task.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-400 transition-opacity">
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
